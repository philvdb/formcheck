var FormCheck=new Class({Implements:[Options,Events],options:{tipsClass:"fc-tbx",errorClass:"fc-error",fieldErrorClass:"fc-field-error",submit:!0,submitAction:!1,submitMethod:!1,trimValue:!1,validateDisabled:!1,submitByAjax:!1,ajaxResponseDiv:!1,ajaxEvalScripts:!1,onAjaxRequest:$empty,onAjaxComplete:$empty,onAjaxSuccess:$empty,onAjaxFailure:$empty,onSubmit:$empty,onValidateSuccess:$empty,onValidateFailure:$empty,display:{showErrors:0,titlesInsteadNames:0,errorsLocation:1,indicateErrors:1,indicateErrorsInit:0,keepFocusOnError:0,checkValueIfEmpty:1,addClassErrorToField:0,removeClassErrorOnTipClosure:0,fixPngForIe:1,replaceTipsEffect:1,flashTips:0,closeTipsButton:1,tipsPosition:"right",tipsOffsetX:-45,tipsOffsetY:0,listErrorsAtTop:!1,scrollToFirst:!0,fadeDuration:300},alerts:{required:"This field is required.",alpha:"This field accepts alphabetic characters only.",alphanum:"This field accepts alphanumeric characters only.",nodigit:"No digits are accepted.",digit:"Please enter a valid integer.",digitltd:"The value must be between %0 and %1",number:"Please enter a valid number.",email:"Please enter a valid email.",image:"This field should only contain image types",phone:"Please enter a valid phone.",phone_inter:"Please enter a valid international phone number.",url:"Please enter a valid url.",confirm:"This field is different from %0",differs:"This value must be different of %0",length_str:"The length is incorrect, it must be between %0 and %1",length_fix:"The length is incorrect, it must be exactly %0 characters",lengthmax:"The length is incorrect, it must be at max %0",lengthmin:"The length is incorrect, it must be at least %0",words_min:"This field must concain at least %0 words, currently: %1 words",words_range:"This field must contain %0-%1 words, currently: %2 words",words_max:"This field must contain at max %0 words, currently: %1 words",checkbox:"Please check the box",checkboxes_group:"Please check at least %0 box(es)",radios:"Please select a radio",select:"Please choose a value",select_multiple:"Please choose at least one value"},regexp:{required:/[^.*]/,alpha:/^[a-z ._-]+$/i,alphanum:/^[a-z0-9 ._-]+$/i,digit:/^[-+]?[0-9]+$/,nodigit:/^[^0-9]+$/,number:/^[-+]?\d*\.?\d+$/,email:/^([a-zA-Z0-9_\.\-\+%])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,image:/.(jpg|jpeg|png|gif|bmp)$/i,phone:/^\+{0,1}[0-9 \(\)\.\-]+$/,phone_inter:/^\+{0,1}[0-9 \(\)\.\-]+$/,url:/^(http|https|ftp)\:\/\/[a-z0-9\-\.]+\.[a-z]{2,3}(:[a-z0-9]*)?\/?([a-z0-9\-\._\?\,\'\/\\\+&amp;%\$#\=~])*$/i}},initialize:function(a,b){if(this.form=$(a))this.form.isValid=!0,this.regex=["length"],this.groups={},typeof formcheckLanguage!="undefined"&&(this.options.alerts=$merge(this.options.alerts,formcheckLanguage)),this.setOptions(b),this.form.setProperty("action",this.options.submitAction||this.form.getProperty("action")||""),this.form.setProperty("method",this.options.submitMethod||this.form.getProperty("method")||""),this.validations=[],this.alreadyIndicated=!1,this.firstError=!1,$H(this.options.regexp).each(function(a,b){this.regex.push(b)},this),this.form.getElements("*[class*=validate]").each(function(a){this.register(a)},this),this.form.addEvents({submit:this.onSubmit.bind(this)}),this.options.display.fixPngForIe&&this.fixIeStuffs(),document.addEvent("mousewheel",function(){this.isScrolling=!1}.bind(this)),this.options.display.indicateErrorsInit&&this.validations.each(function(a){this.manageError(a,"submit")||(this.form.isValid=!1)},this)},register:function(el,position){el.validation=[],el.getProperty("class").split(" ").each(function(classX){if(classX.match(/^validate(\[.+\])$/)){var valid=!0,validators=eval(classX.match(/^validate(\[.+\])$/)[1]);for(var i=0;i<validators.length;i++){el.validation.push(validators[i]);if(validators[i].match(/^confirm:/)){var field=validators[i].match(/.+:(.+)$/)[1];this.form[field].validation.contains("required")&&el.validation.push("required")}validators[i].match(/^target:.+/)&&(el.target=validators[i].match(/^target:(.+)/)[1])}el.isChild=this.isChildType(el,validators),el.isChild&&el.type=="radio"&&this.validations.each(function(a){a.name==el.name&&(valid=!1)},this),el.isChild&&el.type=="checkbox"&&this.validations.each(function(a){a.groupID==el.groupID&&(valid=!1)},this);if(position&&position<=this.validations.length){var newValidations=[];this.validations.each(function(a,b){position==b+1&&valid&&(newValidations.push(el),this.addListener(el)),newValidations.push(a)},this),this.validations=newValidations}else valid&&(this.validations.push(el),this.addListener(el))}},this)},dispose:function(a){this.validations.erase(a)},addListener:function(a){a.errors=[];if(a.validation[0]=="submit")return a.addEvent("click",function(a){(new Event(a)).stop(),this.onSubmit(a)&&this.form.submit()}.bind(this)),!0;if(!a.isChild)a.addEvent("blur",function(){!this.fxRunning&&(a.element||this.options.display.showErrors==1)&&(this.options.display.checkValueIfEmpty||a.value)&&this.manageError(a,"blur")}.bind(this));else if(a.isChild&&a.type=="radio"){var b=this.form.getElements('input[name="'+a.getProperty("name")+'"]');b.each(function(b){b.addEvent("blur",function(){!this.fxRunning&&(a.element||this.options.display.showErrors==1)&&(this.options.display.checkValueIfEmpty||a.value)&&this.manageError(a,"click")}.bind(this))},this)}},manageError:function(a,b){var c=this.validate(a);if(b=="testonly")return c;if(!c&&a.validation.contains("required")||a.value&&!c){this.options.display.listErrorsAtTop&&b=="submit"&&this.listErrorsAtTop(a);if(this.options.display.indicateErrors==2||this.alreadyIndicated==0||a==this.alreadyIndicated)return this.firstError||(this.firstError=a),this.alreadyIndicated=a,this.options.display.keepFocusOnError&&a==this.firstError&&function(){a.focus()}.delay(10),this.addError(a),!1}else if(c||!a.validation.contains("required")&&!a.value)return this.removeError(a),!0;return!0},validate:function(el){return el.errors=[],el.isOk=!0,!this.options.validateDisabled&&el.get("disabled")?!0:(this.options.trimValue&&el.value&&(el.value=el.value.trim()),el.validation.each(function(rule){if(el.isChild)this.validateGroup(el)||(el.isOk=!1);else{var ruleArgs=[];if(rule.match(/target:.+/))return;var ruleMethod=rule;rule.match(/^.+\[/)&&(ruleMethod=rule.split("[")[0],ruleArgs=eval(rule.match(/^.+(\[.+\])$/)[1].replace(/([A-Z0-9\._-]+)/i,"'$1'"))),this.regex.contains(ruleMethod)&&el.get("tag")!="select"&&this.validateRegex(el,ruleMethod,ruleArgs)==0&&(el.isOk=!1),rule.match(/confirm:.+/)&&(ruleArgs=[rule.match(/.+:(.+)$/)[1]],this.validateConfirm(el,ruleArgs)==0&&(el.isOk=!1)),rule.match(/differs:.+/)&&(ruleArgs=[rule.match(/.+:(.+)$/)[1]],this.validateDiffers(el,ruleArgs)==0&&(el.isOk=!1)),ruleMethod=="words"&&this.validateWords(el,ruleArgs)==0&&(el.isOk=!1),ruleMethod=="required"&&(el.get("tag")=="select"||el.type=="checkbox")&&this.simpleValidate(el)==0&&(el.isOk=!1),(rule.match(/%[A-Z0-9\._-]+$/i)||el.isOk&&rule.match(/~[A-Z0-9\._-]+$/i))&&eval(rule.slice(1)+"(el)")==0&&(el.isOk=!1)}},this),el.isOk?!0:!1)},simpleValidate:function(a){if(a.get("tag")=="select")if(!a.multiple){if(a.selectedIndex<=0)return a.errors.push(this.options.alerts.select),!1}else{var b=!1;a.getChildren("option").each(function(a){a.selected&&(b=!0)});if(!b)return a.errors.push(this.options.alerts.select_multiple),!1}else if(a.type=="checkbox"&&a.checked==0)return a.errors.push(this.options.alerts.checkbox),!1;return!0},validateRegex:function(a,b,c){var d="";b=="length"&&c[1]?c[1]==-1?(this.options.regexp.length=new RegExp("^[\\s\\S]{"+c[0]+",}$"),d=this.options.alerts.lengthmin.replace("%0",c[0])):c[0]==c[1]?(this.options.regexp.length=new RegExp("^[\\s\\S]{"+c[0]+"}$"),d=this.options.alerts.length_fix.replace("%0",c[0])):(this.options.regexp.length=new RegExp("^[\\s\\S]{"+c[0]+","+c[1]+"}$"),d=this.options.alerts.length_str.replace("%0",c[0]).replace("%1",c[1])):c[0]&&b=="length"?(this.options.regexp.length=new RegExp("^.{0,"+c[0]+"}$"),d=this.options.alerts.lengthmax.replace("%0",c[0])):d=this.options.alerts[b];if(b!="digit"&&b!="number"||!c[1]){if(this.options.regexp[b].test(a.value)==0)return a.errors.push(d),!1}else{var e,f=!0;this.options.regexp[b].test(a.value)||(a.errors.push(this.options.alerts[b]),f=!1),c[1]==-1?(e=a.value.toFloat()>=c[0].toFloat(),d=this.options.alerts.digitmin.replace("%0",c[0])):(e=a.value.toFloat()>=c[0].toFloat()&&a.value.toFloat()<=c[1].toFloat(),d=this.options.alerts.digitltd.replace("%0",c[0]).replace("%1",c[1]));if(f==0||e==0)return a.errors.push(d),!1}return!0},validateConfirm:function(a,b){var c=b[0];if(a.value!=this.form[c].value){var d=this.options.display.titlesInsteadNames?this.options.alerts.confirm.replace("%0",this.form[c].getProperty("title")):this.options.alerts.confirm.replace("%0",c);return a.errors.push(d),!1}return!0},validateDiffers:function(a,b){var c=b[0];if(a.value==this.form[c].value){var d=this.options.display.titlesInsteadNames?this.options.alerts.differs.replace("%0",this.form[c].getProperty("title")):this.options.alerts.differs.replace("%0",c);return a.errors.push(d),!1}return!0},validateWords:function(a,b){var c=b[0],d=b[1],e=a.value.replace(/[ \t\v\n\r\f\p]/m," ").replace(/[,.;:]/g," ").clean().split(" ");if(d==-1){if(e.length<c)return a.errors.push(this.options.alerts.words_min.replace("%0",c).replace("%1",e.length)),!1}else if(c>0){if(e.length<c||e.length>d)return a.errors.push(this.options.alerts.words_range.replace("%0",c).replace("%1",d).replace("%2",e.length)),!1}else if(e.length>d)return a.errors.push(this.options.alerts.words_max.replace("%0",d).replace("%1",e.length)),!1;return!0},isFormValid:function(){return this.form.isValid=!0,this.validations.each(function(a){var b=this.manageError(a,"testonly");b||(this.form.isValid=!1)},this),this.form.isValid},isChildType:function(el,validators){var validator;if($defined(el.type)&&el.type=="radio")return!0;if(validator=validators.join().match(/group(\[.*\])/)){var group=eval(validator[1]);return this.groups[group[0]]=this.groups[group[0]]||[],this.groups[group[0]][0]=this.groups[group[0]][0]||[],this.groups[group[0]][1]=group[1]||this.groups[group[0]][1]||1,this.groups[group[0]][0].push(el),el.groupID=group[0],!0}return!1},validateGroup:function(a){a.errors=[];if(a.type=="radio"){var b=this.form[a.getProperty("name")];a.group=b;var c=!1;for(var d=0;d<b.length;d++)b[d].checked&&(c=!0);return c==0?(a.errors.push(this.options.alerts.radios),!1):!0}if(a.type=="checkbox"){var e=0;return this.groups[a.groupID][0].each(function(a){a.checked&&e++}),e>=this.groups[a.groupID][1]?!0:(this.groups[a.groupID][0].length>1?a.errors.push(this.options.alerts.checkboxes_group.replace("%0",this.groups[a.groupID][1])):a.errors.push(this.options.alerts.checkbox),!1)}return!1},listErrorsAtTop:function(a){this.form.element||(this.form.element=(new Element("div",{id:"errorlist","class":this.options.errorClass})).injectTop(this.form)),$type(a)=="collection"?(new Element("p")).set("html","<span>"+a[0].name+" : </span>"+a[0].errors[0]).injectInside(this.form.element):(a.validation.contains("required")&&a.errors.length>0||a.errors.length>0&&a.value&&a.validation.contains("required")==0)&&a.errors.each(function(b){(new Element("p")).set("html","<span>"+a.name+" : </span>"+b).injectInside(this.form.element)},this),window.fireEvent("resize")},addError:function(a){var b=a.target?$(a.target).getCoordinates():a.getCoordinates();if(!a.element&&this.options.display.indicateErrors!=0)if(this.options.display.errorsLocation==1){var c=this.options.display.tipsPosition=="left"?b.left:b.right,d={opacity:0,position:"absolute","float":"left",left:c+this.options.display.tipsOffsetX};a.element=(new Element("div",{"class":this.options.tipsClass,styles:d})).injectInside(document.body),this.addPositionEvent(a)}else this.options.display.errorsLocation==2?a.element=(new Element("div",{"class":this.options.errorClass,styles:{opacity:0}})).injectBefore(a):this.options.display.errorsLocation==3&&(a.element=new Element("div",{"class":this.options.errorClass,styles:{opacity:0}}),$type(a.group)=="object"||$type(a.group)=="collection"?a.element.injectAfter(a.group[a.group.length-1]):a.element.injectAfter(a));if(a.element&&a.element!=1){a.element.empty();if(this.options.display.errorsLocation==1){var e=[];a.errors.each(function(a){e.push((new Element("p")).set("html",a))});var f=this.makeTips(e).injectInside(a.element);this.options.display.closeTipsButton&&f.getElements("a.close").addEvent("mouseup",function(){this.removeError(a,"tip")}.bind(this)),a.element.setStyle("top",b.top-f.getCoordinates().height+this.options.display.tipsOffsetY)}else a.errors.each(function(b){(new Element("p")).set("html",b).injectInside(a.element)});!this.options.display.fadeDuration||Browser.Engine.trident&&Browser.Engine.version==5&&this.options.display.errorsLocation<2?a.element.setStyle("opacity",1):(a.fx=new Fx.Tween(a.element,{duration:this.options.display.fadeDuration,ignore:!0,onStart:function(){this.fxRunning=!0}.bind(this),onComplete:function(){this.fxRunning=!1,a.element&&a.element.getStyle("opacity").toInt()==0&&(a.element.destroy(),a.element=!1)}.bind(this)}),a.element.getStyle("opacity").toInt()!=1&&a.fx.start("opacity",1))}this.options.display.addClassErrorToField&&!a.isChild&&(a.addClass(this.options.fieldErrorClass),a.element=a.element||!0)},addPositionEvent:function(a){this.options.display.replaceTipsEffect?a.event=function(){var b=a.target?$(a.target).getCoordinates():a.getCoordinates();(new Fx.Morph(a.element,{duration:this.options.display.fadeDuration})).start({left:[a.element.getStyle("left"),b.right+this.options.display.tipsOffsetX],top:[a.element.getStyle("top"),b.top-a.element.getCoordinates().height+this.options.display.tipsOffsetY]})}.bind(this):a.event=function(){var b=a.target?$(a.target).getCoordinates():a.getCoordinates();a.element.setStyles({left:b.right+this.options.display.tipsOffsetX,top:b.top-a.element.getCoordinates().height+this.options.display.tipsOffsetY})}.bind(this),window.addEvent("resize",a.event)},removeError:function(a,b){(this.options.display.addClassErrorToField&&!a.isChild&&this.options.display.removeClassErrorOnTipClosure||this.options.display.addClassErrorToField&&!a.isChild&&!this.options.display.removeClassErrorOnTipClosure&&b!="tip")&&a.removeClass(this.options.fieldErrorClass);if(!a.element)return;this.alreadyIndicated=!1,a.errors=[],a.isOK=!0,window.removeEvent("resize",a.event),this.options.display.errorsLocation>=2&&a.element&&(new Fx.Tween(a.element,{duration:this.options.display.fadeDuration})).start("height",0),!this.options.display.fadeDuration||Browser.Engine.trident&&Browser.Engine.version==5&&this.options.display.errorsLocation==1&&a.element?(this.fxRunning=!0,a.element.destroy(),a.element=!1,function(){this.fxRunning=!1}.bind(this).delay(200)):a.element&&a.element!=1&&a.fx.start("opacity",0)},focusOnError:function(a){if(this.options.display.scrollToFirst&&!this.alreadyFocused&&!this.isScrolling){var b;if(!this.options.display.indicateErrors||!this.options.display.errorsLocation)b=a.getCoordinates().top-30;else{switch(this.options.display.errorsLocation){case 1:b=a.element.getCoordinates().top;break;case 2:b=a.element.getCoordinates().top-30;break;case 3:b=a.getCoordinates().top-30}this.isScrolling=!0}window.getScroll().y!=b?(new Fx.Scroll(window,{onComplete:function(){this.isScrolling=!1,a.getProperty("type")!="hidden"&&a.focus()}.bind(this)})).start(0,b):(this.isScrolling=!1,a.focus()),this.alreadyFocused=!0}},fixIeStuffs:function(){if(Browser.Engine.trident4){var a=new RegExp("url\\(([.a-zA-Z0-9_/:-]+.png)\\)"),b=new RegExp("(.+)formcheck.css");for(var c=0;c<document.styleSheets.length;c++)if(document.styleSheets[c].href.match(/formcheck\.css$/)){var d=document.styleSheets[c].href.replace(b,"$1"),e=document.styleSheets[c].rules.length;for(var f=0;f<e;f++){var g=document.styleSheets[c].rules[f].style,h=d+g.backgroundImage.replace(a,"$1");if(h&&h.match(/\.png/i)){var i=g.backgroundRepeat=="no-repeat"?"crop":"scale";g.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, src='"+h+"', sizingMethod='"+i+"')",g.backgroundImage="none"}}}}},makeTips:function(a){var b=new Element("table");b.cellPadding="0",b.cellSpacing="0",b.border="0";var c=(new Element("tbody")).injectInside(b),d=(new Element("tr")).injectInside(c);(new Element("td",{"class":"tl"})).injectInside(d),(new Element("td",{"class":"t"})).injectInside(d),(new Element("td",{"class":"tr"})).injectInside(d);var e=(new Element("tr")).injectInside(c);(new Element("td",{"class":"l"})).injectInside(e);var f=(new Element("td",{"class":"c"})).injectInside(e),g=(new Element("div",{"class":"err"})).injectInside(f);a.each(function(a){a.injectInside(g)}),this.options.display.closeTipsButton&&(new Element("a",{"class":"close"})).injectInside(f),(new Element("td",{"class":"r"})).injectInside(e);var h=(new Element("tr")).injectInside(c);return(new Element("td",{"class":"bl"})).injectInside(h),(new Element("td",{"class":"b"})).injectInside(h),(new Element("td",{"class":"br"})).injectInside(h),b},reinitialize:function(a){this.validations.each(function(b){if(b.element){b.errors=[],b.isOK=!0;if(this.options.display.flashTips==1||a=="forced")b.element.destroy(),b.element=!1}},this),this.form.element&&this.form.element.empty(),this.alreadyFocused=!1,this.firstError=!1,this.elementToRemove=this.alreadyIndicated,this.alreadyIndicated=!1,this.form.isValid=!0},submitByAjax:function(){return this.fireEvent("ajaxRequest"),(new Request({url:this.form.action,method:this.form.method,data:this.form.toQueryString(),evalScripts:this.options.ajaxEvalScripts,onFailure:function(a){this.fireEvent("ajaxFailure",a)}.bind(this),onComplete:function(a){this.fireEvent("ajaxComplete",a)}.bind(this),onSuccess:function(a){this.fireEvent("ajaxSuccess",a),this.options.ajaxResponseDiv&&$(this.options.ajaxResponseDiv).set("html",a)}.bind(this)})).send(),!1},onSubmit:function(a){return this.reinitialize(),this.fireEvent("onSubmit"),this.validations.each(function(a){var b=this.manageError(a,"submit");b||(this.form.isValid=!1)},this),this.form.isValid?(this.fireEvent("validateSuccess"),this.options.submitByAjax?this.submitByAjax():this.options.submit):(this.elementToRemove&&this.elementToRemove!=this.firstError&&this.options.display.indicateErrors==1&&this.removeError(this.elementToRemove),this.focusOnError(this.firstError),this.fireEvent("validateFailure"),!1)}})